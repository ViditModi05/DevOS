<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>DEV COMMAND CENTER v6.4</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Inter:wght@400;600;800&display=swap');

        :root {
            --unreal-blue: #3b82f6;
            --unity-dark: #10b981;
        }

        body {
            background-color: #0f0f13;
            color: #e0e0e0;
            font-family: 'Inter', sans-serif;
            min-height: 100vh;
            min-height: 100dvh;
        }

        .mono { font-family: 'JetBrains Mono', monospace; }

        .card {
            background: #1a1a20;
            border: 1px solid #333;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.5);
            transition: all 0.3s ease;
        }

        .unreal-mode { border-color: var(--unreal-blue); box-shadow: 0 0 20px rgba(59, 130, 246, 0.15); }
        .unity-mode { border-color: var(--unity-dark); box-shadow: 0 0 20px rgba(16, 185, 129, 0.15); }

        body.zen-active .zen-hidden {
            opacity: 0.1;
            filter: blur(2px);
            pointer-events: none;
        }
        body.zen-active #timer-card {
            transform: scale(1.02);
            z-index: 50;
            box-shadow: 0 0 50px rgba(0,0,0,0.8);
        }

        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #0f0f13; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }

        .btn-glitch { position: relative; overflow: hidden; transition: all 0.2s; }
        .btn-glitch:active { transform: scale(0.98); }

        .pulse-red { animation: pulse-red 2s infinite; }
        @keyframes pulse-red {
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            70% { box-shadow: 0 0 0 6px rgba(239, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }

        .modal { transition: opacity 0.2s ease-in-out; opacity: 0; pointer-events: none; }
        .modal.active { opacity: 1; pointer-events: all; }
    </style>
</head>
<body class="flex flex-col transition-all duration-500 overflow-x-hidden pb-6 lg:pb-0">

    <!-- TOP BAR -->
    <header class="h-16 border-b border-gray-800 flex items-center justify-between px-4 lg:px-6 bg-[#141419] zen-hidden shrink-0 sticky top-0 z-40 w-full overflow-hidden">
        <div class="flex items-center gap-2 sm:gap-4 shrink-0 mr-2">
            <i class="fas fa-terminal text-xl sm:text-2xl text-emerald-400"></i>
            <h1 class="text-lg sm:text-xl font-bold tracking-wider text-white whitespace-nowrap">DEV<span class="text-emerald-400">OS</span> <span class="text-gray-600 text-xs sm:text-sm font-normal hidden sm:inline">// v6.4</span></h1>
        </div>
        
        <div class="flex items-center gap-2 sm:gap-6 shrink-0 ml-auto">
            <button onclick="toggleGitStatus()" id="git-status-btn" class="flex items-center gap-2 px-2 sm:px-3 py-1 rounded text-[10px] sm:text-xs font-bold bg-red-900/20 text-red-400 border border-red-900 transition-all hover:bg-red-900/40 shrink-0" title="Click to confirm Push">
                <i class="fas fa-code-branch"></i> <span id="git-status-text" class="hidden sm:inline">UNCOMMITTED</span>
            </button>

            <div class="h-6 w-px bg-gray-800 hidden sm:block"></div>

            <!-- Data Controls -->
            <div class="flex gap-2 hidden sm:flex items-center">
                <button onclick="openHistoryModal()" class="text-xs text-emerald-400 hover:text-white transition-colors font-bold bg-emerald-900/10 px-2 py-1 rounded border border-emerald-900/30 whitespace-nowrap"><i class="fas fa-history mr-1"></i> LOG WORK</button>
                <div class="w-px h-4 bg-gray-700 mx-2"></div>
                <button onclick="exportData()" class="text-xs text-gray-500 hover:text-white transition-colors" title="Save"><i class="fas fa-download"></i></button>
                <label class="text-xs text-gray-500 hover:text-white transition-colors cursor-pointer" title="Load">
                    <i class="fas fa-upload"></i>
                    <input type="file" id="import-file" class="hidden" onchange="importData(this)">
                </label>
            </div>

            <!-- Stats Group -->
            <div class="flex gap-3 items-center ml-2 border-l border-gray-800 pl-2">
                <div class="flex flex-col w-20 sm:w-32 lg:w-40 shrink-0">
                    <div class="flex justify-between text-[10px] mono mb-1">
                        <span id="level-display" class="text-yellow-400 font-bold">LVL 0</span>
                        <span id="xp-display" class="text-gray-400">0 XP</span>
                    </div>
                    <div class="h-1.5 bg-gray-700 rounded-full overflow-hidden">
                        <div id="xp-bar" class="h-full bg-gradient-to-r from-yellow-600 to-yellow-400 w-0 transition-all duration-500"></div>
                    </div>
                </div>
                <div class="text-center shrink-0">
                    <div class="text-[8px] sm:text-[10px] text-gray-500 font-bold uppercase">Streak</div>
                    <div class="text-base sm:text-lg font-bold text-white mono leading-none"><i class="fas fa-fire text-orange-500 mr-1"></i> <span id="streak-count">0</span></div>
                </div>
            </div>
        </div>
    </header>

    <!-- MOBILE NAV -->
    <div class="lg:hidden fixed bottom-0 left-0 right-0 bg-[#141419] border-t border-gray-800 flex justify-around p-3 z-50 zen-hidden">
        <button onclick="scrollToSection('timer-section')" class="text-white flex flex-col items-center text-xs"><i class="fas fa-stopwatch text-lg mb-1"></i>Timer</button>
        <button onclick="scrollToSection('tasks-section')" class="text-gray-500 hover:text-white flex flex-col items-center text-xs"><i class="fas fa-tasks text-lg mb-1"></i>Tasks</button>
        <button onclick="scrollToSection('courses-section')" class="text-gray-500 hover:text-white flex flex-col items-center text-xs"><i class="fas fa-network-wired text-lg mb-1"></i>Skills</button>
        <button onclick="openHistoryModal()" class="text-gray-500 hover:text-white flex flex-col items-center text-xs"><i class="fas fa-history text-lg mb-1"></i>Logs</button>
    </div>

    <!-- MAIN GRID -->
    <main class="flex-1 p-4 lg:p-6 grid grid-cols-1 lg:grid-cols-12 gap-6 overflow-y-auto lg:overflow-hidden mb-16 lg:mb-0">
        
        <!-- LEFT -->
        <div id="timer-section" class="lg:col-span-3 flex flex-col gap-6 h-auto lg:h-full">
            <div class="card p-6 flex flex-col items-center justify-center relative transition-all duration-300" id="timer-card">
                <div id="smart-focus-banner" class="absolute top-0 w-full bg-gray-800 text-[10px] font-bold text-center py-1 text-gray-400 rounded-t-lg border-b border-gray-700">DETECTING TIME...</div>
                <div class="absolute top-8 right-4 flex gap-3 mt-2 items-center">
                    <button onclick="toggleZenMode()" class="text-gray-500 hover:text-emerald-400" title="Zen Mode"><i class="fas fa-eye"></i></button>
                    <span class="text-gray-700 hidden sm:inline">|</span>
                    <div class="hidden sm:flex gap-2">
                        <button onclick="setTimerMode('stopwatch')" id="mode-stopwatch" class="text-[10px] font-bold text-white">STOPWATCH</button>
                        <button onclick="setTimerMode('pomodoro')" id="mode-pomodoro" class="text-[10px] font-bold text-gray-500 hover:text-white">POMODORO</button>
                    </div>
                </div>
                <div class="flex bg-gray-900 p-1 rounded-lg mb-6 w-full mt-12">
                    <button onclick="switchEngine('unreal')" id="btn-unreal" class="flex-1 py-3 lg:py-2 text-xs font-bold rounded text-gray-400 hover:text-white transition-colors"><i class="fas fa-cube mr-2"></i>UNREAL</button>
                    <button onclick="switchEngine('unity')" id="btn-unity" class="flex-1 py-3 lg:py-2 text-xs font-bold rounded text-gray-400 hover:text-white transition-colors"><i class="brands fa-unity mr-2"></i>UNITY</button>
                </div>
                <div class="mono text-6xl lg:text-5xl font-bold mb-2 text-white transition-colors tracking-tighter" id="timer-display">00:00:00</div>
                <div class="text-xs text-gray-400 mb-6" id="session-label">System Idle...</div>
                <button onclick="toggleTimer()" id="main-action-btn" class="w-full py-4 lg:py-3 bg-emerald-600 hover:bg-emerald-500 text-white font-bold rounded-lg shadow-lg shadow-emerald-900/20 btn-glitch text-sm transition-all active:scale-95">INITIALIZE</button>
            </div>

            <div class="card p-4 flex flex-col overflow-hidden zen-hidden h-auto">
                <div class="flex justify-between items-center mb-3">
                    <h2 class="font-bold text-gray-300 text-[10px] uppercase tracking-widest"><i class="fas fa-link mr-2 text-cyan-400"></i>THE PORTAL</h2>
                    <button onclick="addPortalLink()" class="text-[10px] text-gray-500 hover:text-white"><i class="fas fa-plus"></i> ADD</button>
                </div>
                <div id="portal-links" class="grid grid-cols-2 gap-2 overflow-y-auto max-h-32"></div>
            </div>

            <div class="card p-0 flex-1 flex flex-col overflow-hidden zen-hidden min-h-[200px]">
                <div class="flex border-b border-gray-700">
                    <button onclick="switchNoteTab('general')" id="tab-general" class="flex-1 py-3 lg:py-2 text-[10px] font-bold bg-[#1a1a20] text-gray-300 border-r border-gray-700">GENERAL</button>
                    <button onclick="switchNoteTab('unreal')" id="tab-unreal" class="flex-1 py-3 lg:py-2 text-[10px] font-bold bg-gray-900 text-gray-500 border-r border-gray-700">UNREAL</button>
                    <button onclick="switchNoteTab('unity')" id="tab-unity" class="flex-1 py-3 lg:py-2 text-[10px] font-bold bg-gray-900 text-gray-500">UNITY</button>
                </div>
                <textarea id="quick-notes" class="flex-1 bg-[#141419] p-4 text-xs mono text-gray-300 resize-none focus:outline-none leading-relaxed" placeholder="// Select a tab to start logging notes..."></textarea>
            </div>
        </div>

        <!-- CENTER -->
        <div id="courses-section" class="lg:col-span-6 flex flex-col gap-6 h-auto lg:h-full overflow-hidden zen-hidden">
            <div class="card p-5 shrink-0">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="font-bold text-gray-300 text-sm"><i class="fas fa-network-wired mr-2 text-blue-400"></i>ACTIVE COURSES</h2>
                    <button onclick="openCourseModal()" class="text-[10px] bg-gray-800 hover:bg-gray-700 px-3 py-1 rounded text-gray-300 border border-gray-700">+ ADD NEW</button>
                </div>
                <div id="courses-list" class="space-y-3 lg:max-h-56 overflow-y-auto pr-1"></div>
            </div>

            <div id="tasks-section" class="card p-0 flex-1 flex flex-col overflow-hidden min-h-[300px]">
                <div class="p-4 border-b border-gray-800 bg-[#1a1a20] z-10 flex flex-col sm:flex-row justify-between items-start sm:items-center gap-2">
                    <div class="flex items-center gap-2 w-full sm:w-auto justify-between sm:justify-start">
                        <h2 class="font-bold text-gray-300 text-sm whitespace-nowrap"><i class="fas fa-scroll mr-2 text-yellow-400"></i>QUEST LOG</h2>
                        <select id="task-priority" class="bg-gray-900 border border-gray-700 text-xs text-gray-300 rounded px-2 py-1 focus:outline-none ml-auto sm:ml-0">
                            <option value="high">High</option>
                            <option value="med" selected>Normal</option>
                            <option value="low">Low</option>
                        </select>
                    </div>
                    <div class="flex w-full sm:w-auto flex-1 gap-2">
                        <input type="text" id="new-task-input" placeholder="Add bug, feature..." class="bg-gray-900 border border-gray-700 rounded px-3 py-2 lg:py-1 text-sm text-white focus:outline-none focus:border-emerald-500 w-full" onkeypress="if(event.key === 'Enter') addTask()">
                        <button onclick="addTask()" class="bg-emerald-600 hover:bg-emerald-500 text-white px-3 py-1 rounded text-sm"><i class="fas fa-plus"></i></button>
                    </div>
                </div>
                <div id="task-list" class="flex-1 overflow-y-auto p-2 space-y-1 bg-[#141419]"></div>
            </div>
        </div>

        <!-- RIGHT -->
        <div class="lg:col-span-3 flex flex-col gap-6 h-auto lg:h-full zen-hidden">
            <div class="card p-4 h-48">
                <h2 class="font-bold text-gray-300 text-[10px] mb-2 uppercase tracking-widest">7-Day Performance</h2>
                <div class="relative h-32 w-full">
                    <canvas id="activityChart"></canvas>
                </div>
            </div>

            <div class="card p-5 flex-1 overflow-y-auto relative min-h-[250px]">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="font-bold text-gray-300 text-[10px] uppercase tracking-widest">Deployment Schedule</h2>
                    <button onclick="openScheduleModal()" class="text-gray-500 hover:text-white"><i class="fas fa-pen text-xs"></i></button>
                </div>
                <div class="space-y-3 text-xs" id="schedule-display"></div>
            </div>
        </div>
    </main>

    <!-- MODALS -->
    <div id="history-modal" class="modal fixed inset-0 bg-black/90 z-[60] flex items-center justify-center backdrop-blur-sm p-4">
        <div class="card w-full max-w-md p-6 bg-[#1a1a20] border border-gray-700 shadow-2xl h-[80vh] flex flex-col">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-lg font-bold text-white">Session Logs</h2>
                <button onclick="closeModal('history-modal')" class="text-gray-500 hover:text-white p-2"><i class="fas fa-times text-lg"></i></button>
            </div>
            <div id="history-list" class="flex-1 overflow-y-auto space-y-2 mb-4 pr-1 border-b border-gray-800 pb-4"></div>
            <h3 class="text-xs font-bold text-gray-500 uppercase mb-2">Add Past Session</h3>
            <div class="grid grid-cols-2 gap-2 mb-2">
                <input type="date" id="hist-date" class="bg-gray-900 border border-gray-700 rounded p-2 text-xs text-white outline-none">
                <select id="hist-engine" class="bg-gray-900 border border-gray-700 rounded p-2 text-xs text-white outline-none">
                    <option value="unreal">Unreal Engine</option>
                    <option value="unity">Unity</option>
                </select>
            </div>
            <div class="flex gap-2">
                <input type="number" id="hist-hours" step="0.1" class="flex-1 bg-gray-900 border border-gray-700 rounded p-2 text-xs text-white outline-none" placeholder="Hours (e.g. 1.5)">
                <button onclick="addManualLog()" class="px-4 bg-emerald-600 hover:bg-emerald-500 text-white text-xs font-bold rounded">ADD</button>
            </div>
        </div>
    </div>

    <div id="course-modal" class="modal fixed inset-0 bg-black/90 z-[60] flex items-center justify-center backdrop-blur-sm p-4">
        <div class="card w-full max-w-md p-6 bg-[#1a1a20] border border-gray-700 shadow-2xl">
            <h2 class="text-lg font-bold text-white mb-4" id="modal-title">Add Course</h2>
            <div class="space-y-4">
                <div><label class="text-xs text-gray-500 uppercase font-bold block mb-1">Course Name</label><input type="text" id="course-name" class="w-full bg-gray-900 border border-gray-700 rounded p-3 text-sm text-white outline-none"></div>
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="text-xs text-gray-500 uppercase font-bold block mb-1">Current</label><input type="number" id="course-current" class="w-full bg-gray-900 border border-gray-700 rounded p-3 text-sm text-white outline-none"></div>
                    <div><label class="text-xs text-gray-500 uppercase font-bold block mb-1">Total</label><input type="number" id="course-total" class="w-full bg-gray-900 border border-gray-700 rounded p-3 text-sm text-white outline-none"></div>
                </div>
                <div><label class="text-xs text-gray-500 uppercase font-bold block mb-1">Color</label><div class="flex gap-2"><button onclick="selectColor('bg-blue-600')" class="w-8 h-8 rounded-full bg-blue-600 ring-2 ring-offset-2 ring-offset-gray-900 ring-transparent hover:ring-white"></button><button onclick="selectColor('bg-purple-600')" class="w-8 h-8 rounded-full bg-purple-600 ring-2 ring-offset-2 ring-offset-gray-900 ring-transparent hover:ring-white"></button><button onclick="selectColor('bg-emerald-600')" class="w-8 h-8 rounded-full bg-emerald-600 ring-2 ring-offset-2 ring-offset-gray-900 ring-transparent hover:ring-white"></button><button onclick="selectColor('bg-orange-600')" class="w-8 h-8 rounded-full bg-orange-600 ring-2 ring-offset-2 ring-offset-gray-900 ring-transparent hover:ring-white"></button></div></div>
            </div>
            <div class="flex justify-end gap-2 mt-6"><button onclick="closeModal('course-modal')" class="px-4 py-3 text-xs text-gray-400 hover:text-white">Cancel</button><button onclick="saveCourse()" class="px-4 py-3 bg-blue-600 hover:bg-blue-500 text-white text-xs font-bold rounded">Save</button></div>
        </div>
    </div>

    <div id="schedule-modal" class="modal fixed inset-0 bg-black/90 z-[60] flex items-center justify-center backdrop-blur-sm p-4">
        <div class="card w-full max-w-md p-6 bg-[#1a1a20] border border-gray-700 shadow-2xl">
            <h2 class="text-lg font-bold text-white mb-4">Edit Schedule</h2>
            <div class="space-y-4">
                <div><label class="text-xs text-blue-400 uppercase font-bold block mb-1">Morning Task (Unreal)</label><input type="text" id="edit-morn-task" class="w-full bg-gray-900 border border-gray-700 rounded p-3 text-sm text-white outline-none mb-2"><input type="text" id="edit-morn-note" class="w-full bg-gray-900 border border-gray-700 rounded p-2 text-xs text-gray-400 outline-none"></div>
                <div><label class="text-xs text-emerald-400 uppercase font-bold block mb-1">Night Task (Unity)</label><input type="text" id="edit-night-task" class="w-full bg-gray-900 border border-gray-700 rounded p-3 text-sm text-white outline-none mb-2"><input type="text" id="edit-night-note" class="w-full bg-gray-900 border border-gray-700 rounded p-2 text-xs text-gray-400 outline-none"></div>
                <div class="pt-2 border-t border-gray-700"><label class="text-xs text-gray-500 uppercase font-bold block mb-1">Sprint Focus</label><input type="text" id="edit-sprint-name" class="w-full bg-gray-900 border border-gray-700 rounded p-3 text-sm text-white outline-none mb-2"><input type="text" id="edit-sprint-focus" class="w-full bg-gray-900 border border-gray-700 rounded p-3 text-sm text-white outline-none"></div>
            </div>
            <div class="flex justify-end gap-2 mt-6"><button onclick="closeModal('schedule-modal')" class="px-4 py-3 text-xs text-gray-400 hover:text-white">Cancel</button><button onclick="saveSchedule()" class="px-4 py-3 bg-emerald-600 hover:bg-emerald-500 text-white text-xs font-bold rounded">Save</button></div>
        </div>
    </div>

    <script>
        // AUDIO ENGINE
        const AudioEngine = {
            ctx: new (window.AudioContext || window.webkitAudioContext)(),
            playTone: function(freq, type, duration) {
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                osc.type = type;
                osc.frequency.value = freq;
                osc.connect(gain);
                gain.connect(this.ctx.destination);
                osc.start();
                gain.gain.exponentialRampToValueAtTime(0.00001, this.ctx.currentTime + duration);
                osc.stop(this.ctx.currentTime + duration);
            },
            click: function() { this.playTone(800, 'sine', 0.1); },
            complete: function() { this.playTone(600, 'square', 0.1); setTimeout(() => this.playTone(800, 'square', 0.1), 100); setTimeout(() => this.playTone(1200, 'square', 0.3), 200); },
            levelUp: function() { this.playTone(400, 'sawtooth', 0.1); setTimeout(() => this.playTone(500, 'sawtooth', 0.1), 100); setTimeout(() => this.playTone(600, 'sawtooth', 0.1), 200); setTimeout(() => this.playTone(800, 'sawtooth', 0.4), 300); }
        };

        // STATE
        const STATE = {
            currentEngine: 'unreal', currentNoteTab: 'general', timerMode: 'stopwatch', isTimerRunning: false,
            startTime: 0, elapsedTime: 0, pomodoroTime: 25 * 60 * 1000, timerInterval: null,
            totalHours: 0, streak: 0, gitPushed: false, logs: [],
            courses: [ { id: 1, name: "Ulibarri: Ultimate C++", total: 130, current: 0, color: "bg-blue-600" }, { id: 2, name: "Unity Netcode (NGO)", total: 25, current: 0, color: "bg-emerald-600" } ],
            tasks: [ { id: 1, text: "Implement Lobby Code UI", done: false, priority: "high" }, { id: 2, text: "Boss State Machine Logic", done: false, priority: "med" } ],
            notes: { general: "", unreal: "", unity: "" },
            portalLinks: {
                unreal: [{ id: 1, name: "UE5 C++ API", url: "https://docs.unrealengine.com/5.0/en-US/API/", color: "text-blue-400", bg: "bg-blue-900/20" }, { id: 2, name: "Blueprint Nodes", url: "https://docs.unrealengine.com/5.0/en-US/blueprint-api-reference/", color: "text-blue-300", bg: "bg-blue-900/20" }],
                unity: [{ id: 3, name: "Unity Script API", url: "https://docs.unity3d.com/ScriptReference/", color: "text-emerald-400", bg: "bg-emerald-900/20" }, { id: 4, name: "Netcode Docs", url: "https://docs-multiplayer.unity3d.com/", color: "text-teal-300", bg: "bg-teal-900/20" }]
            },
            schedule: { morning: "1 Video + 30m Lab", morningNote: "No-Copy Rule Active", night: "2 Hours Production", nightNote: "Ship Features Only", sprintName: "Unreal: AI / Behavior Trees", sprintFocus: "Unity: Boss State Machine" },
            modalMode: 'add', editingId: null, selectedColor: 'bg-blue-600', lastLoginDate: new Date().toDateString(), zenMode: false
        };

        let chartInstance = null;

        window.onload = () => {
            if (Notification.permission !== "granted") Notification.requestPermission();
            loadData(); checkDateReset(); renderUI(); initChart(); checkCurrentFocus();
            setInterval(checkCurrentFocus, 60000); setInterval(saveData, 30000);
        };

        function scrollToSection(id) { document.getElementById(id).scrollIntoView({ behavior: 'smooth' }); }

        function loadData() {
            const saved = localStorage.getItem('dev_os_v6');
            if (saved) {
                const parsed = JSON.parse(saved);
                Object.assign(STATE, parsed);
                if(!Array.isArray(STATE.logs)) STATE.logs = []; 
                if(typeof STATE.streak === 'undefined') STATE.streak = 0;
            }
            document.getElementById('quick-notes').value = STATE.notes[STATE.currentNoteTab];
            updateGitStatusUI(); updateLevel();
        }

        function saveData() {
            STATE.notes[STATE.currentNoteTab] = document.getElementById('quick-notes').value;
            localStorage.setItem('dev_os_v6', JSON.stringify(STATE));
        }

        function checkDateReset() {
            const today = new Date().toDateString();
            if (STATE.lastLoginDate !== today) { 
                const yesterday = new Date(); yesterday.setDate(yesterday.getDate() - 1);
                if(STATE.lastLoginDate === yesterday.toDateString()) STATE.streak++;
                else if (new Date(STATE.lastLoginDate) < yesterday) STATE.streak = 0;
                STATE.gitPushed = false; STATE.lastLoginDate = today; 
                saveData(); updateGitStatusUI(); updateLevel(); 
            }
        }

        // TIMER LOGIC FIX
        function toggleTimer() {
            const btn = document.getElementById('main-action-btn');
            if (!STATE.isTimerRunning) {
                STATE.isTimerRunning = true;
                if (STATE.timerMode === 'stopwatch') STATE.startTime = Date.now() - STATE.elapsedTime;
                else { STATE.startTime = Date.now(); STATE.elapsedTime = 0; }
                STATE.timerInterval = setInterval(updateTimerDisplay, 1000);
                btn.innerText = STATE.timerMode === 'stopwatch' ? "STOP & LOG" : "ABORT MISSION";
                btn.classList.replace('bg-emerald-600', 'bg-red-600'); btn.classList.replace('hover:bg-emerald-500', 'hover:bg-red-500');
                AudioEngine.click();
            } else {
                STATE.isTimerRunning = false; clearInterval(STATE.timerInterval);
                
                let hoursLogged = 0;
                const now = Date.now();
                const sessionDuration = now - STATE.startTime;
                
                if (STATE.timerMode === 'stopwatch') {
                    // Correct calculation for Stopwatch
                    hoursLogged = sessionDuration / 3600000;
                    STATE.elapsedTime = 0; 
                    updateTimerDisplay(); 
                } else {
                    // Pomodoro: Log actual time spent even if aborted
                    hoursLogged = sessionDuration / 3600000;
                    document.getElementById('timer-display').innerText = "00:25:00";
                }
                
                if(hoursLogged > 0.001) {
                    STATE.logs.push({ id: now, timestamp: now, engine: STATE.currentEngine, hours: hoursLogged });
                    STATE.totalHours += hoursLogged;
                    updateLevel(); updateChartData();
                    if (STATE.currentEngine === 'unity') showGitReminder();
                    saveData(); AudioEngine.complete();
                }
                btn.innerText = "INITIALIZE"; btn.classList.replace('bg-red-600', 'bg-emerald-600'); btn.classList.replace('hover:bg-red-500', 'hover:bg-emerald-500');
            }
        }

        function updateTimerDisplay() {
            let displayTime = 0;
            if (STATE.timerMode === 'stopwatch') displayTime = STATE.isTimerRunning ? Date.now() - STATE.startTime : STATE.elapsedTime;
            else {
                const elapsed = STATE.isTimerRunning ? Date.now() - STATE.startTime : 0;
                displayTime = STATE.pomodoroTime - elapsed;
                if (displayTime <= 0) { toggleTimer(); alert("MISSION COMPLETE"); return; }
            }
            const date = new Date(displayTime);
            document.getElementById('timer-display').innerText = date.toISOString().substr(11, 8);
        }

        // HISTORY
        function openHistoryModal() { renderHistoryList(); document.getElementById('history-modal').classList.add('active'); document.getElementById('hist-date').valueAsDate = new Date(); }
        function closeModal(id){document.getElementById(id).classList.remove('active');}
        function renderHistoryList() {
            const c = document.getElementById('history-list'); c.innerHTML = '';
            const sorted = [...STATE.logs].sort((a, b) => b.timestamp - a.timestamp);
            if(sorted.length === 0) { c.innerHTML = '<div class="text-xs text-gray-500 text-center py-4">No logs yet. Start coding!</div>'; return; }
            sorted.forEach(l => {
                const d = new Date(l.timestamp).toLocaleDateString();
                const col = l.engine === 'unreal' ? 'text-blue-400' : 'text-emerald-400';
                const ic = l.engine === 'unreal' ? 'fa-cube' : 'fa-layer-group';
                c.innerHTML += `<div class="flex justify-between items-center p-2 bg-gray-900 rounded border border-gray-800 text-xs"><div class="flex items-center gap-2"><i class="fas ${ic} ${col}"></i><span class="text-gray-300">${d}</span><span class="text-gray-500 font-bold">${l.hours.toFixed(2)}h</span></div><button onclick="deleteLog(${l.id})" class="text-gray-600 hover:text-red-500 px-2"><i class="fas fa-trash"></i></button></div>`;
            });
        }
        function addManualLog() {
            const d = document.getElementById('hist-date').value, e = document.getElementById('hist-engine').value, h = parseFloat(document.getElementById('hist-hours').value);
            if (!d || isNaN(h) || h <= 0) return;
            const ts = new Date(d + 'T12:00:00').getTime();
            STATE.logs.push({ id: Date.now(), timestamp: ts, engine: e, hours: h });
            STATE.totalHours += h; saveData(); updateLevel(); updateChartData(); renderHistoryList(); AudioEngine.levelUp();
        }
        function deleteLog(id) {
            if(!confirm("Delete?")) return;
            const idx = STATE.logs.findIndex(l => l.id === id);
            if (idx > -1) { STATE.totalHours -= STATE.logs[idx].hours; STATE.logs.splice(idx, 1); saveData(); updateLevel(); updateChartData(); renderHistoryList(); }
        }

        // CHART
        function updateChartData() {
            if (!chartInstance) return;
            const lbl = [], uData = [], nData = [];
            for (let i = 6; i >= 0; i--) {
                const d = new Date(); d.setDate(d.getDate() - i);
                const k = d.toLocaleDateString();
                lbl.push(d.toLocaleDateString('en-US', { weekday: 'short' }));
                let u=0, n=0;
                STATE.logs.forEach(l => { if (new Date(l.timestamp).toLocaleDateString() === k) { if(l.engine === 'unreal') u += l.hours; else n += l.hours; } });
                uData.push(u); nData.push(n);
            }
            chartInstance.data.labels = lbl; chartInstance.data.datasets[0].data = uData; chartInstance.data.datasets[1].data = nData; chartInstance.update();
        }

        // STANDARD UI
        function updateLevel() {
            const lvl = Math.floor(STATE.totalHours / 10); const xp = Math.floor(STATE.totalHours % 10);
            document.getElementById('level-display').innerText = `LVL ${lvl}`;
            document.getElementById('xp-display').innerText = `${xp.toFixed(1)}/10 XP`;
            document.getElementById('xp-bar').style.width = `${(xp / 10) * 100}%`;
            document.getElementById('streak-count').innerText = STATE.streak;
        }
        function switchEngine(e) { if(STATE.isTimerRunning)return; STATE.currentEngine=e; renderEngineUI(); renderPortal(); }
        function renderEngineUI() {
            const c=document.getElementById('timer-card'), u=document.getElementById('btn-unreal'), n=document.getElementById('btn-unity');
            if(STATE.currentEngine==='unreal'){ c.className="card p-6 flex flex-col items-center justify-center relative transition-all duration-300 unreal-mode"; u.className="flex-1 py-3 lg:py-2 text-xs font-bold rounded bg-blue-600 text-white transition-colors"; n.className="flex-1 py-3 lg:py-2 text-xs font-bold rounded text-gray-400 hover:text-white transition-colors"; document.getElementById('session-label').innerText="Morning Protocol: Learning Mode"; }
            else { c.className="card p-6 flex flex-col items-center justify-center relative transition-all duration-300 unity-mode"; n.className="flex-1 py-3 lg:py-2 text-xs font-bold rounded bg-emerald-600 text-white transition-colors"; u.className="flex-1 py-3 lg:py-2 text-xs font-bold rounded text-gray-400 hover:text-white transition-colors"; document.getElementById('session-label').innerText="Night Protocol: Production Mode"; }
        }
        function renderPortal() {
            const c=document.getElementById('portal-links'); c.innerHTML='';
            (STATE.portalLinks[STATE.currentEngine]||[]).forEach(l=>{ c.innerHTML+=`<div class="group relative flex items-center justify-center p-2 rounded border border-gray-800 hover:border-gray-600 ${l.bg} transition-all"><a href="${l.url}" target="_blank" class="text-[10px] font-bold ${l.color} truncate">${l.name}</a><button onclick="deletePortalLink(${l.id})" class="absolute right-1 opacity-0 group-hover:opacity-100 text-gray-500 hover:text-red-500 text-[10px]"><i class="fas fa-times"></i></button></div>`; });
        }
        function addPortalLink() {
            const name=prompt("Name:"); if(!name)return; const url=prompt("URL:"); if(!url)return;
            const c = STATE.currentEngine==='unreal' ? "text-blue-300" : "text-emerald-300";
            const b = STATE.currentEngine==='unreal' ? "bg-blue-900/20" : "bg-emerald-900/20";
            if(!STATE.portalLinks[STATE.currentEngine]) STATE.portalLinks[STATE.currentEngine]=[];
            STATE.portalLinks[STATE.currentEngine].push({id:Date.now(), name, url, color:c, bg:b}); saveData(); renderPortal();
        }
        function deletePortalLink(id) { if(confirm("Delete?")){ STATE.portalLinks[STATE.currentEngine] = STATE.portalLinks[STATE.currentEngine].filter(x=>x.id!==id); saveData(); renderPortal(); }}
        function toggleGitStatus(){STATE.gitPushed=!STATE.gitPushed; saveData(); updateGitStatusUI();}
        function updateGitStatusUI(){const b=document.getElementById('git-status-btn'),t=document.getElementById('git-status-text'); if(STATE.gitPushed){b.className="flex items-center gap-2 px-3 py-1 rounded text-xs font-bold bg-emerald-900/20 text-emerald-400 border border-emerald-900 transition-all shrink-0";t.innerText="COMMITTED";b.classList.remove('pulse-red');}else{b.className="flex items-center gap-2 px-3 py-1 rounded text-xs font-bold bg-red-900/20 text-red-400 border border-red-900 transition-all pulse-red hover:bg-red-900/40 shrink-0";t.innerText="UNCOMMITTED";}}
        function showGitReminder(){STATE.gitPushed=false; updateGitStatusUI(); alert("⚠️ GIT CHECK: Push your code!");}
        function checkCurrentFocus(){const h=new Date().getHours(), b=document.getElementById('smart-focus-banner'); if(h>=6&&h<12){b.innerHTML="<i class='fas fa-sun text-yellow-400 mr-2'></i> MORNING PROTOCOL: <span class='text-blue-300'>UNREAL LEARNING</span>";b.className="absolute top-0 w-full bg-blue-900/40 text-[10px] font-bold text-center py-1 text-blue-200 rounded-t-lg border-b border-blue-800";}else if(h>=12&&h<17){b.innerHTML="<i class='fas fa-coffee text-orange-400 mr-2'></i> AFTERNOON BRIDGE: <span class='text-gray-300'>RESET / LAB</span>";b.className="absolute top-0 w-full bg-gray-800/80 text-[10px] font-bold text-center py-1 text-gray-400 rounded-t-lg border-b border-gray-700";}else if(h>=17||h<2){b.innerHTML="<i class='fas fa-moon text-emerald-400 mr-2'></i> NIGHT PROTOCOL: <span class='text-emerald-300'>UNITY PRODUCTION</span>";b.className="absolute top-0 w-full bg-emerald-900/40 text-[10px] font-bold text-center py-1 text-emerald-200 rounded-t-lg border-b border-emerald-800";}else{b.innerHTML="<i class='fas fa-bed text-purple-400 mr-2'></i> REST PROTOCOL: <span class='text-purple-300'>SLEEP IS CRITICAL</span>";b.className="absolute top-0 w-full bg-purple-900/40 text-[10px] font-bold text-center py-1 text-purple-200 rounded-t-lg border-b border-purple-800";}}
        
        function exportData(){const s="data:text/json;charset=utf-8,"+encodeURIComponent(JSON.stringify(STATE)); const e=document.createElement('a'); e.setAttribute("href",s); e.setAttribute("download","gamedev_backup.json"); document.body.appendChild(e); e.click(); e.remove();}
        function importData(input){const f=input.files[0]; if(!f)return; const r=new FileReader(); r.onload=function(e){try{const d=JSON.parse(e.target.result); Object.assign(STATE,d); saveData(); location.reload();}catch(err){alert("Invalid File");}}; r.readAsText(f);}

        function renderSchedule() {
            const schedDiv = document.getElementById('schedule-display');
            schedDiv.innerHTML = `<div class="p-3 bg-blue-900/20 border border-blue-900 rounded"><div class="font-bold text-blue-400 mb-1">MORNING (UNREAL)</div><div class="text-gray-400" id="sched-morn-task">${STATE.schedule.morning}</div><div class="text-gray-500 italic mt-1" id="sched-morn-note">${STATE.schedule.morningNote}</div></div><div class="p-3 bg-emerald-900/20 border border-emerald-900 rounded"><div class="font-bold text-emerald-400 mb-1">NIGHT (UNITY)</div><div class="text-gray-400" id="sched-night-task">${STATE.schedule.night}</div><div class="text-gray-500 italic mt-1" id="sched-night-note">${STATE.schedule.nightNote}</div></div><div class="mt-6 pt-4 border-t border-gray-800"><div class="text-[10px] text-gray-500 font-bold mb-2">CURRENT SPRINT</div><div class="text-white font-bold" id="sched-sprint-name">${STATE.schedule.sprintName}</div><div class="text-white font-bold mt-1" id="sched-sprint-focus">${STATE.schedule.sprintFocus}</div></div>`;
        }
        function openScheduleModal(){document.getElementById('edit-morn-task').value=STATE.schedule.morning; document.getElementById('edit-morn-note').value=STATE.schedule.morningNote; document.getElementById('edit-night-task').value=STATE.schedule.night; document.getElementById('edit-night-note').value=STATE.schedule.nightNote; document.getElementById('edit-sprint-name').value=STATE.schedule.sprintName; document.getElementById('edit-sprint-focus').value=STATE.schedule.sprintFocus; document.getElementById('schedule-modal').classList.add('active');}
        function saveSchedule(){STATE.schedule.morning=document.getElementById('edit-morn-task').value; STATE.schedule.morningNote=document.getElementById('edit-morn-note').value; STATE.schedule.night=document.getElementById('edit-night-task').value; STATE.schedule.nightNote=document.getElementById('edit-night-note').value; STATE.schedule.sprintName=document.getElementById('edit-sprint-name').value; STATE.schedule.sprintFocus=document.getElementById('edit-sprint-focus').value; saveData(); renderSchedule(); closeModal('schedule-modal');}
        function toggleZenMode(){STATE.zenMode=!STATE.zenMode; if(STATE.zenMode)document.body.classList.add('zen-active'); else document.body.classList.remove('zen-active');}
        function switchNoteTab(tab){STATE.notes[STATE.currentNoteTab]=document.getElementById('quick-notes').value; STATE.currentNoteTab=tab; document.getElementById('quick-notes').value=STATE.notes[tab]||""; ['general','unreal','unity'].forEach(t=>{const b=document.getElementById(`tab-${t}`); if(t===tab){b.classList.replace('bg-gray-900','bg-[#141419]');b.classList.replace('text-gray-500','text-gray-300');}else{b.classList.replace('bg-[#141419]','bg-gray-900');b.classList.replace('text-gray-300','text-gray-500');}});}
        function setTimerMode(m){if(STATE.isTimerRunning)return; STATE.timerMode=m; document.getElementById('mode-stopwatch').className=m==='stopwatch'?"text-[10px] font-bold text-white":"text-[10px] font-bold text-gray-500 hover:text-white"; document.getElementById('mode-pomodoro').className=m==='pomodoro'?"text-[10px] font-bold text-white":"text-[10px] font-bold text-gray-500 hover:text-white"; document.getElementById('timer-display').innerText=m==='stopwatch'?"00:00:00":"00:25:00";}

        function renderCourses(){const c=document.getElementById('courses-list'); c.innerHTML=''; STATE.courses.forEach(course=>{const p=Math.round((course.current/course.total)*100); c.innerHTML+=`<div class="bg-[#141419] p-3 rounded border border-gray-800 hover:border-gray-600 transition-colors group relative"><div class="flex justify-between mb-1 items-center"><span class="text-xs font-bold text-gray-300 truncate w-32">${course.name}</span><span class="text-[10px] mono text-gray-500">${course.current}/${course.total} (${p}%)</span></div><div class="w-full bg-gray-800 rounded-full h-1.5 cursor-pointer" onclick="editCourse(${course.id})"><div class="h-1.5 rounded-full ${course.color} transition-all duration-500" style="width: ${p}%"></div></div><div class="absolute right-2 top-2 opacity-0 group-hover:opacity-100 transition-opacity"><button onclick="editCourse(${course.id})" class="text-gray-500 hover:text-white"><i class="fas fa-pen text-xs"></i></button></div></div>`;});}
        function openCourseModal(mode='add',id=null){STATE.modalMode=mode; STATE.editingId=id; document.getElementById('course-modal').classList.add('active'); if(mode==='edit'){const c=STATE.courses.find(x=>x.id===id); document.getElementById('course-name').value=c.name; document.getElementById('course-current').value=c.current; document.getElementById('course-total').value=c.total;}else{document.getElementById('course-name').value=""; document.getElementById('course-current').value=0; document.getElementById('course-total').value=100;}}
        function saveCourse(){const n=document.getElementById('course-name').value, c=parseInt(document.getElementById('course-current').value), t=parseInt(document.getElementById('course-total').value); if(!n)return; if(STATE.modalMode==='add') STATE.courses.push({id:Date.now(), name:n, current:c, total:t, color:STATE.selectedColor}); else {const course=STATE.courses.find(x=>x.id===STATE.editingId); if(course){course.name=n;course.current=c;course.total=t;course.color=STATE.selectedColor;}} saveData(); renderCourses(); closeModal('course-modal');}
        function editCourse(id){openCourseModal('edit', id);}
        function selectColor(c){STATE.selectedColor=c;}

        function renderTasks(){const c=document.getElementById('task-list'); c.innerHTML=''; const s=[...STATE.tasks].sort((a,b)=>{const p={high:3,med:2,low:1};return p[b.priority]-p[a.priority]}); s.forEach(t=>{let bc="border-gray-800", bg="bg-gray-800 text-gray-500"; if(t.priority==='high'){bc="border-l-2 border-l-red-500 bg-red-900/10"; bg="text-red-400 bg-red-900/20";} if(t.priority==='med'){bc="border-l-2 border-l-blue-500"; bg="text-blue-400 bg-blue-900/20";} c.innerHTML+=`<div class="flex items-center justify-between p-2 rounded border ${bc} hover:bg-gray-800/50 group transition-all"><div class="flex items-center gap-3"><button onclick="toggleTask(${t.id})" class="w-4 h-4 border border-gray-600 rounded flex items-center justify-center ${t.done?'bg-emerald-600 border-emerald-600':''}">${t.done?'<i class="fas fa-check text-[8px] text-white"></i>':''}</button><span class="${t.done?'line-through text-gray-600':'text-gray-300'} text-xs">${t.text}</span></div><div class="flex items-center gap-2"><span class="text-[9px] px-1.5 py-0.5 rounded uppercase ${bg}">${t.priority}</span><button onclick="deleteTask(${t.id})" class="text-gray-600 hover:text-red-500 opacity-0 group-hover:opacity-100"><i class="fas fa-trash text-xs"></i></button></div></div>`;});}
        function addTask(){const v=document.getElementById('new-task-input').value;if(!v.trim())return; STATE.tasks.push({id:Date.now(),text:v,done:false,priority:document.getElementById('task-priority').value}); document.getElementById('new-task-input').value=""; saveData(); renderTasks();}
        function toggleTask(id){const t=STATE.tasks.find(x=>x.id===id);if(t){t.done=!t.done; if(t.done)AudioEngine.click(); saveData(); renderTasks();}}
        function deleteTask(id){STATE.tasks=STATE.tasks.filter(x=>x.id!==id); saveData(); renderTasks();}

        function renderUI(){switchEngine('unreal'); renderCourses(); renderTasks(); renderPortal(); renderSchedule();}
        function initChart(){const c=document.getElementById('activityChart').getContext('2d'); chartInstance=new Chart(c,{type:'bar',data:{labels:[],datasets:[{label:'Unreal',data:[],backgroundColor:'#3b82f6',borderRadius:2},{label:'Unity',data:[],backgroundColor:'#10b981',borderRadius:2}]},options:{responsive:true,maintainAspectRatio:false,scales:{x:{stacked:true,grid:{display:false},ticks:{color:'#666',font:{size:9}}},y:{stacked:true,grid:{color:'#333'},ticks:{color:'#666',font:{size:9}}}},plugins:{legend:{display:false}}}}); updateChartData();}
    </script>
</body>
</html>